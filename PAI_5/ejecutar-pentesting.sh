#!/bin/bash
#
# ejecutar-pentesting.sh - Script Maestro de PAI-5 RedTeamPro
# Ejecuta todas las fases del pentesting de forma automatizada
# Autor: PAI-5 RedTeamPro Team
# Fecha: $(date +%Y-%m-%d)
#

set -e

# Cargar funciones comunes
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/07-Scripts/utils.sh"

# Variables globales
TARGET_URL="${TARGET_URL:-http://localhost:80}"
DVWA_SESSION=""
INTERACTIVE_MODE="${INTERACTIVE_MODE:-true}"

# ============================================================================
# FUNCIONES DE CONFIGURACI√ìN
# ============================================================================

# Banner principal
show_main_banner() {
    echo -e "${BLUE}"
    cat << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                  ‚ïë
‚ïë           PAI-5 RedTeamPro - Pentesting Automatizado            ‚ïë
‚ïë           DVWA Security Assessment - Full Cycle                 ‚ïë
‚ïë                                                                  ‚ïë
‚ïë   Framework: NIST 800-115 + MITRE ATT&CK                        ‚ïë
‚ïë   Target: DVWA (Damn Vulnerable Web Application)                ‚ïë
‚ïë                                                                  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
    echo -e "${NC}"
}

# Verificar prerrequisitos
check_prerequisites() {
    info "Verificando prerrequisitos..."

    # Verificar que DVWA est√© corriendo
    if ! curl -s --max-time 5 "$TARGET_URL" > /dev/null 2>&1; then
        error "DVWA no est√° accesible en $TARGET_URL"
        info "Iniciando DVWA..."

        cd "$PROJECT_ROOT/01-Planificacion"
        if docker compose ps | grep -q "dvwa.*Up"; then
            log "DVWA ya est√° corriendo"
        else
            docker compose up -d
            sleep 10
            log "DVWA iniciado"
        fi
        cd "$PROJECT_ROOT"
    else
        log "DVWA est√° accesible en $TARGET_URL"
    fi

    # Verificar herramientas
    local required_tools=("nmap" "curl" "nikto")
    for tool in "${required_tools[@]}"; do
        if ! command_exists "$tool"; then
            error "Herramienta requerida no encontrada: $tool"
            info "Instalar con: sudo apt-get install $tool"
            exit 1
        fi
    done

    log "Prerrequisitos verificados"
}

# Obtener sesi√≥n de DVWA
get_dvwa_session() {
    info "Configurando sesi√≥n DVWA..."

    if [ -n "$DVWA_SESSION" ]; then
        log "Usando sesi√≥n proporcionada: $DVWA_SESSION"
        return 0
    fi

    # Intentar login autom√°tico
    warning "Intentando login autom√°tico en DVWA..."

    # Login en DVWA
    local login_response=$(curl -s -c /tmp/dvwa_cookies.txt \
        -d "username=admin&password=password&Login=Login" \
        "$TARGET_URL/login.php")

    # Obtener PHPSESSID de las cookies
    if [ -f /tmp/dvwa_cookies.txt ]; then
        DVWA_SESSION=$(grep PHPSESSID /tmp/dvwa_cookies.txt | awk '{print $7}')

        if [ -n "$DVWA_SESSION" ]; then
            log "Sesi√≥n DVWA obtenida: $DVWA_SESSION"

            # Configurar nivel de seguridad a 'low'
            curl -s -b "PHPSESSID=$DVWA_SESSION" \
                -d "security=low&seclev_submit=Submit" \
                "$TARGET_URL/security.php" > /dev/null

            log "Nivel de seguridad configurado a: low"
            return 0
        fi
    fi

    warning "No se pudo obtener sesi√≥n autom√°ticamente"

    if [ "$INTERACTIVE_MODE" = "true" ]; then
        echo ""
        warning "Para funcionalidad completa (SQLMap), necesitas obtener PHPSESSID manualmente:"
        echo "  1. Abre $TARGET_URL en navegador"
        echo "  2. Login: admin / password"
        echo "  3. F12 > Application > Cookies > Copiar PHPSESSID"
        echo ""
        read -p "¬øDeseas introducir PHPSESSID ahora? (s/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Ss]$ ]]; then
            read -p "Introduce PHPSESSID: " DVWA_SESSION
            log "Sesi√≥n configurada manualmente"
        else
            warning "Continuando sin sesi√≥n (SQLMap se omitir√°)"
        fi
    fi
}

# Confirmar ejecuci√≥n
confirm_execution() {
    if [ "$INTERACTIVE_MODE" = "true" ]; then
        echo ""
        separator
        info "Se ejecutar√°n las siguientes fases:"
        echo "  1. Reconocimiento (nmap, fingerprinting)"
        echo "  2. Escaneo de Vulnerabilidades (nikto, an√°lisis)"
        echo "  3. Explotaci√≥n SQL Injection (manual - si hay sesi√≥n)"
        echo "  4. Mapeo MITRE ATT&CK"
        echo "  5. Generaci√≥n de Informe"
        separator
        echo ""
        read -p "¬øContinuar con el pentesting automatizado? (s/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Ss]$ ]]; then
            warning "Ejecuci√≥n cancelada por el usuario"
            exit 0
        fi
    fi
}

# ============================================================================
# FASES DEL PENTESTING
# ============================================================================

# Fase 0: Setup
fase_0_setup() {
    show_banner "Fase 0: Setup y Configuraci√≥n" "Preparando entorno"

    info "Verificando estructura de directorios..."
    ensure_dir "$PROJECT_ROOT/02-Reconocimiento/nmap-results"
    ensure_dir "$PROJECT_ROOT/02-Reconocimiento/fingerprinting"
    ensure_dir "$PROJECT_ROOT/03-Escaneo/nikto-output"
    ensure_dir "$PROJECT_ROOT/03-Escaneo/sqlmap-output"
    ensure_dir "$PROJECT_ROOT/03-Escaneo/vulnerability-reports"
    ensure_dir "$PROJECT_ROOT/06-Evidencias/screenshots"
    ensure_dir "$PROJECT_ROOT/06-Evidencias/logs"
    ensure_dir "$PROJECT_ROOT/06-Evidencias/network-captures"

    log "Estructura de directorios lista"

    # Resetear contador de evidencias
    bash "$SCRIPT_DIR/capture-evidence.sh" --reset-counter 2>/dev/null || true

    sleep 2
}

# Fase 1: Reconocimiento
fase_1_reconocimiento() {
    show_banner "Fase 1: Reconocimiento" "MITRE ATT&CK: T1046, T1595"

    info "Iniciando fase de reconocimiento automatizada..."
    echo ""

    # Ejecutar script de reconocimiento
    if bash "$SCRIPT_DIR/reconocimiento.sh" "$TARGET_URL"; then
        log "Reconocimiento completado exitosamente"
    else
        error "Error en fase de reconocimiento"
        return 1
    fi

    echo ""
    separator
    log "Fase 1 completada"
    separator
    echo ""

    if [ "$INTERACTIVE_MODE" = "true" ]; then
        read -p "Presiona ENTER para continuar a la siguiente fase..."
    else
        sleep 3
    fi
}

# Fase 2: Escaneo de Vulnerabilidades
fase_2_escaneo() {
    show_banner "Fase 2: Escaneo de Vulnerabilidades" "MITRE ATT&CK: T1595.002"

    info "Iniciando escaneo de vulnerabilidades..."
    echo ""

    # Ejecutar script de escaneo
    # Simular respuestas autom√°ticas
    echo -e "n\nn\nn\n" | bash "$SCRIPT_DIR/escaneo-vulnerabilidades.sh" "$TARGET_URL" || true

    log "Escaneo de vulnerabilidades completado"

    echo ""
    separator
    log "Fase 2 completada"
    separator
    echo ""

    if [ "$INTERACTIVE_MODE" = "true" ]; then
        read -p "Presiona ENTER para continuar a la siguiente fase..."
    else
        sleep 3
    fi
}

# Fase 3: Explotaci√≥n SQL Injection
fase_3_sqli_exploit() {
    show_banner "Fase 3: SQL Injection Exploitation" "MITRE ATT&CK: T1213"

    if [ -z "$DVWA_SESSION" ]; then
        warning "Sesi√≥n DVWA no disponible - Omitiendo SQL Injection"
        warning "Ejecuta manualmente: bash 07-Scripts/ejecutar-sqli-final.sh"
        echo ""
        separator
        log "Fase 3 omitida"
        separator
        echo ""
        if [ "$INTERACTIVE_MODE" = "true" ]; then
            read -p "Presiona ENTER para continuar..."
        else
            sleep 2
        fi
        return 0
    fi

    info "Ejecutando script de SQL Injection..."
    echo ""

    # Ejecutar el script standalone que funciona correctamente
    if bash "$SCRIPT_DIR/ejecutar-sqli-final.sh"; then
        log "‚úì SQL Injection exploitation completada"
    else
        warning "Error en SQL Injection (puede haber expirado la sesi√≥n)"
        warning "Ejecuta manualmente: bash 07-Scripts/ejecutar-sqli-final.sh"
    fi

    echo ""
    separator
    log "Fase 3 completada"
    separator
    echo ""

    if [ "$INTERACTIVE_MODE" = "true" ]; then
        read -p "Presiona ENTER para continuar..."
    else
        sleep 3
    fi
}

# Fase 4: Mapeo MITRE ATT&CK
fase_4_mapping() {
    show_banner "Fase 4: Mapeo MITRE ATT&CK" "An√°lisis de t√©cnicas utilizadas"

    info "Generando mapeo a MITRE ATT&CK..."
    echo ""

    if python3 "$SCRIPT_DIR/mapeo-attack.py" \
        --output "$PROJECT_ROOT/08-Informe/mapeo-attack.md"; then
        log "Mapeo ATT&CK generado exitosamente"
    else
        warning "Error generando mapeo ATT&CK (continuando...)"
    fi

    echo ""
    separator
    log "Fase 4 completada"
    separator
    echo ""

    sleep 2
}

# Fase 5: Generaci√≥n de Informe
fase_5_informe() {
    show_banner "Fase 5: Generaci√≥n de Informe" "Reporte T√©cnico Consolidado"

    info "Generando informe t√©cnico final..."
    echo ""

    if bash "$SCRIPT_DIR/generar-informe.sh"; then
        log "Informe generado exitosamente"
    else
        error "Error generando informe"
        return 1
    fi

    echo ""
    separator
    log "Fase 5 completada"
    separator
    echo ""
}

# ============================================================================
# RESUMEN FINAL
# ============================================================================

generate_execution_summary() {
    local end_time=$(date '+%Y-%m-%d %H:%M:%S')

    echo ""
    echo -e "${BLUE}"
    cat << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                  ‚ïë
‚ïë              PENTESTING AUTOMATIZADO COMPLETADO                 ‚ïë
‚ïë                                                                  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
    echo -e "${NC}"
    echo ""

    separator
    echo -e "${GREEN}RESUMEN DE EJECUCI√ìN${NC}"
    separator
    echo ""

    echo "üìä Fases Ejecutadas:"
    echo "  ‚úÖ Fase 0: Setup y Configuraci√≥n"
    echo "  ‚úÖ Fase 1: Reconocimiento"
    echo "  ‚úÖ Fase 2: Escaneo de Vulnerabilidades"
    if [ -n "$DVWA_SESSION" ]; then
        echo "  ‚úÖ Fase 3: Explotaci√≥n SQL Injection (Manual)"
    else
        echo "  ‚è≠Ô∏è  Fase 3: Explotaci√≥n SQL Injection (Omitida - sin sesi√≥n)"
    fi
    echo "  ‚úÖ Fase 4: Mapeo MITRE ATT&CK"
    echo "  ‚úÖ Fase 5: Generaci√≥n de Informe"
    echo ""

    echo "üìÅ Resultados Generados:"
    echo ""

    # Contar archivos generados
    local nmap_count=$(find "$PROJECT_ROOT/02-Reconocimiento/nmap-results" -type f 2>/dev/null | wc -l)
    local fingerprint_count=$(find "$PROJECT_ROOT/02-Reconocimiento/fingerprinting" -type f 2>/dev/null | wc -l)
    local nikto_count=$(find "$PROJECT_ROOT/03-Escaneo/nikto-output" -type f 2>/dev/null | wc -l)
    local vuln_reports_count=$(find "$PROJECT_ROOT/03-Escaneo/vulnerability-reports" -type f 2>/dev/null | wc -l)
    local sqli_count=$(find "$PROJECT_ROOT/04-Explotacion/sqli-results" -type f 2>/dev/null | wc -l)

    echo "  üìÇ Reconocimiento:"
    echo "     ‚Ä¢ Escaneos Nmap: $nmap_count archivos"
    echo "     ‚Ä¢ Fingerprinting: $fingerprint_count archivos"
    echo ""
    echo "  üìÇ Escaneo de Vulnerabilidades:"
    echo "     ‚Ä¢ Nikto: $nikto_count archivos"
    echo "     ‚Ä¢ Reportes: $vuln_reports_count archivos"
    echo ""
    echo "  üìÇ Explotaci√≥n:"
    if [ "$sqli_count" -gt 0 ]; then
        echo "     ‚Ä¢ SQL Injection: $sqli_count archivos"
    else
        echo "     ‚Ä¢ SQL Injection: No ejecutada"
    fi
    echo ""
    echo "  üìÇ Informes:"
    echo "     ‚Ä¢ Informe T√©cnico: 08-Informe/Informe-Tecnico-PAI5.md"
    echo "     ‚Ä¢ Mapeo ATT&CK: 08-Informe/mapeo-attack.md"
    echo "     ‚Ä¢ Mapeo JSON: 08-Informe/mapeo-attack.json"
    echo ""

    separator
    echo -e "${CYAN}PR√ìXIMOS PASOS${NC}"
    separator
    echo ""
    echo "1Ô∏è‚É£  Revisar informe t√©cnico:"
    echo "   cat 08-Informe/Informe-Tecnico-PAI5.md"
    echo ""
    echo "2Ô∏è‚É£  Revisar mapeo ATT&CK:"
    echo "   cat 08-Informe/mapeo-attack.md"
    echo ""
    echo "3Ô∏è‚É£  Para explotaci√≥n MANUAL (Fase 4):"
    echo "   cd 04-Explotacion"
    echo "   cat README.md"
    echo ""
    echo "4Ô∏è‚É£  Para capturar evidencias durante explotaci√≥n:"
    echo "   bash 07-Scripts/capture-evidence.sh --screenshot exploit sqli \"descripcion\" T1213"
    echo ""
    echo "5Ô∏è‚É£  Regenerar informe despu√©s de explotaci√≥n manual:"
    echo "   bash 07-Scripts/generar-informe.sh"
    echo ""

    if [ -z "$DVWA_SESSION" ]; then
        separator
        echo -e "${YELLOW}NOTA IMPORTANTE${NC}"
        separator
        echo ""
        warning "Explotaci√≥n SQL Injection no se ejecut√≥ por falta de sesi√≥n DVWA"
        echo ""
        echo "Para ejecutar explotaci√≥n SQL Injection manualmente:"
        echo "  1. Vuelve a ejecutar el script maestro (intentar√° login autom√°tico)"
        echo "  2. O usa el helper manual:"
        echo ""
        echo "     bash 07-Scripts/dvwa-sqli-helper.sh session"
        echo "     export DVWA_SESSION=\"<phpsessid-obtenida>\""
        echo "     bash 07-Scripts/dvwa-sqli-helper.sh exploit \"\$DVWA_SESSION\""
        echo ""
    fi

    separator
    echo -e "${GREEN}Hora de finalizaci√≥n: $end_time${NC}"
    separator
    echo ""

    log "Pentesting automatizado completado exitosamente"
}

# ============================================================================
# FUNCI√ìN PRINCIPAL
# ============================================================================

main() {
    # Banner principal
    show_main_banner

    # Procesar argumentos
    while [[ $# -gt 0 ]]; do
        case $1 in
            --target|-t)
                TARGET_URL="$2"
                shift 2
                ;;
            --session|-s)
                DVWA_SESSION="$2"
                shift 2
                ;;
            --non-interactive|-n)
                INTERACTIVE_MODE="false"
                shift
                ;;
            --help|-h)
                show_usage "ejecutar-pentesting.sh" \
                    "Script maestro para pentesting automatizado de DVWA" \
                    "bash ejecutar-pentesting.sh [opciones]" \
                    "  ${GREEN}Ejecuci√≥n b√°sica:${NC}
    bash ejecutar-pentesting.sh

  ${GREEN}Con sesi√≥n DVWA:${NC}
    bash ejecutar-pentesting.sh --session \"tu-phpsessid\"

  ${GREEN}Target personalizado:${NC}
    bash ejecutar-pentesting.sh --target http://192.168.1.100

  ${GREEN}Modo no interactivo:${NC}
    bash ejecutar-pentesting.sh --non-interactive

  ${GREEN}Opciones:${NC}
    -t, --target URL        URL del target (default: http://localhost:80)
    -s, --session ID        PHPSESSID de DVWA para SQLMap
    -n, --non-interactive   Ejecutar sin pausas
    -h, --help              Mostrar esta ayuda"
                exit 0
                ;;
            *)
                error "Opci√≥n desconocida: $1"
                info "Usa --help para ver opciones disponibles"
                exit 1
                ;;
        esac
    done

    # Inicializar script
    init_script "ejecutar-pentesting.sh"

    # Informaci√≥n inicial
    info "Target: $TARGET_URL"
    if [ -n "$DVWA_SESSION" ]; then
        info "Sesi√≥n DVWA: Proporcionada"
    else
        warning "Sesi√≥n DVWA: No proporcionada (SQLMap se omitir√° o intentar√° auto-login)"
    fi
    echo ""

    # Verificar prerrequisitos
    check_prerequisites

    # Obtener sesi√≥n DVWA
    get_dvwa_session

    # Confirmar ejecuci√≥n
    confirm_execution

    echo ""
    separator
    info "INICIANDO PENTESTING AUTOMATIZADO"
    separator
    echo ""

    # Ejecutar fases
    fase_0_setup
    fase_1_reconocimiento
    fase_2_escaneo

    # SQL Injection Exploitation solo si hay sesi√≥n
    if [ -n "$DVWA_SESSION" ]; then
        fase_3_sqli_exploit
    else
        warning "Omitiendo Fase 3 (SQL Injection) - Sin sesi√≥n DVWA"
    fi

    fase_4_mapping
    fase_5_informe

    # Resumen final
    generate_execution_summary

    # Finalizar script
    finish_script "ejecutar-pentesting.sh"
}

# Ejecutar funci√≥n principal
if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
    main "$@"
fi
